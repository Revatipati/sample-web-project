pipeline {
    agent any // selection of agents 
    // defining environment variables 
    environment {
        REPO_NAME  = 'https://github.com/Revatipati/sample-web-project.git'
        BRANCH_NAME = 'master'
        SONAR_TOKEN = credentials('rp-day3- sonar-token')
        SONAR_SERVER_NAME = 'RPSonarQube'
        SONAR_PROJECT_KEY = 'RPProjDay3'
        DOCKER_CREDS = 'rpdockerID'
        IAMGE_NAME = 'docker.io/revatipatic1/rpwebapp-iis-ltsc2022'
        IMAGE_TAG = 'codev1'
      //  SONAR_HOME = 'C:\\Users\\Administrator\\Documents\\tools\\sonar-scanner\\bin'

    }
    stages {
        // stage1
        stage('testing and verify of required  commands') {
            steps {                
                echo 'checking sonar version'
                bat 'sonar-scanner --version'
                echo 'checking java version'
                bat 'docker version'
                echo 'chekcing java version'
                bat 'java -version'
            }
        }//end of testing and verify of required  commands

        stage('clone') {
            steps {
                echo 'clone repo to project'
                git url: "${REPO_NAME}", branch: "${BRANCH_NAME}"
            }
        }//end of clone

        stage('SAST') {
            steps {
                echo 'sast with sonar scanner'
                script {
                    withSonarQubeEnv("${SONAR_SERVER_NAME}"){
                        bat """
                        sonar-scanner \
                        -Dsonar.projectKey=${SONAR_PROJECT_KEY} \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=${SONAR_HOST_URL}  \
                        -Dsonar.token=${SONAR_TOKEN}
                        """
                    }
                    
                }
                
            }
        }//end of SAST

        stage('build docker image') {
            steps {
                echo 'strat docker image'
                script {
                    def imageName = 'docker.io/revatipatic1/rpwebapp-iis-ltsc2022'
                    def imageTag = 'codev1'
                    docker.build("${imageName}:${imageTag}",".")
                }
                bat 'docker images | findstr rpwebapp'
            }
        }//end of build docker image

        stage('SAST using Trivy') {
            steps {
                echo 'scan the conatier image by using Trivy'
                bat 'trivy image --severity HIGH,CRITICAL --exit-code 1 registry.hub.docker.com/revatipatic1/rpwebapp-iis-ltsc2022:codev1'
            }
        }//end of SAST using Trivy

        stage('Docker image push') {
            steps {
                echo 'push the docker hub image'
                script {
                    def imageName  = "revatipatic1/rpwebapp-iis-ltsc2022"
                    def imageTag   = "codev1"
                    def hubCred   = "${DOCKER_CREDS}"
                    // calling jenkins plugin docker pipeline to push
                    docker.withRegistry('https://registry.hub.docker.com',hubCred){
                        docker.image(imageName + ":" + imageTag).push()

                }
            }
        }
     
    }//end of Docker image push
    stage('deploy app using container image') {
        steps {
                echo 'deploying app using container'
                bat """
                echo trying to remove container with same name 
                docker rm rpappc1 -f  >null 2>&1 || echo Container found found 
                docker  run -itd --name rpappc1 -p 1122:80  ${IAMGE_NAME}:${IMAGE_TAG}
                docker  ps | findstr rpappc1 
                """
            }

    }//end deploy app using container image
    
    }
}